<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CashCactus{% endblock %}</title>
    
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #329937; /* cactus */
            --primary-dark: #439649;
            --primary-light: #66bb6a;
            --secondary-color: #424242;
            --background-color: #fafafa;
            --surface-color: #ffffff;
            --error-color: #d32f2f;
            --warning-color: #f57c00;
            --success-color: #388e3c;
            --info-color: #0288d1;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --header-h: 64px;
        }

        [data-theme='dark'] {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-primary: #f1f1f1;
            --text-secondary: #b3b3b3;
            --border-color: #2c2c2c;
            --shadow-1: 0 1px 3px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.5);
            --shadow-2: 0 4px 10px rgba(0,0,0,0.65), 0 2px 4px rgba(0,0,0,0.55);
            --shadow-3: 0 10px 30px rgba(0,0,0,0.7), 0 6px 12px rgba(0,0,0,0.6);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* Header moderno */
        .modern-header {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            box-shadow: var(--shadow-2);
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            height: var(--header-h);
            backdrop-filter: blur(10px);
            transition: transform .45s ease;
        }
        [data-theme='dark'] .modern-header { background: linear-gradient(135deg, #1d1d1d 0%, #151515 100%); }
        .modern-header.header-hidden { transform: translateY(-100%); }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            padding: 0 24px;
            max-width: 1400px;
            margin: 0 auto;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .logo:hover {
            color: white;
            text-decoration: none;
        }

        .logo-img {
            height: 40px;
            width: auto;
            margin-right: 12px;
            display: block;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.35));
            transition: transform .25s ease, filter .3s ease;
        }

        .logo:hover .logo-img {
            transform: scale(1.05) rotate(-1deg);
            filter: drop-shadow(0 3px 4px rgba(0,0,0,0.45));
        }

        .logo-text {
            font-weight: 700;
            letter-spacing: .5px;
            line-height: 1;
            display: inline-block;
        }

        .header-actions {
            display: flex;
            align-items: center;
            /* gap: 8px; */
            margin-left: auto;
            min-width: 0; /* allow shrink */
        }

        /* Truncar nombre usuario si muy largo */
        .user-btn .username-text { display: inline-block; vertical-align: middle; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Móvil: ocultar texto para ganar espacio */
        @media (max-width: 640px) {
            .logo-text { display: none; }
            .logo-img { height: 36px; margin-right: 0; }
            .user-btn .username-text { display: none; }
        }

        /* Tema oscuro: aclarar un poco el logo si el PNG es oscuro */
    [data-theme='dark'] .logo-img { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.75)) brightness(1.12); }

        .logo .material-icons {
            font-size: 28px;
            margin-right: 12px;
        }

        /* Sidebar moderno */
        .modern-sidebar {
            position: fixed;
            top: var(--header-h);
            left: 0;
            width: 280px;
            height: calc(100vh - var(--header-h));
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 999;
            transform: translateX(0);
            transition: transform .3s cubic-bezier(0.4,0,0.2,1), top .45s ease, height .45s ease;
        }
        [data-theme='dark'] .modern-sidebar { background: #1e1e1e; }
        body.header-hidden .modern-sidebar { top: 0; height: 100vh; }

        .sidebar-content {
            padding: 24px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 24px 8px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            margin: 4px 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

    .nav-link:hover { background: rgba(0,0,0,0.05); color: var(--primary-color); text-decoration: none; }
    [data-theme='dark'] .nav-link:hover { background: rgba(255,255,255,0.08); }

    .nav-link.active { background: rgba(50,153,55,0.18); color: var(--primary-color); font-weight: 600; }
    [data-theme='dark'] .nav-link.active { background: rgba(50,153,55,0.28); }

        .nav-link .material-icons {
            margin-right: 16px;
            font-size: 24px;
        }

        /* Contenido principal */
    .main-content { margin-left: var(--sidebar-w, 280px); margin-top: var(--header-h); padding: 32px; min-height: calc(100vh - var(--header-h)); transition: margin-top .45s ease; }
    body.header-hidden .main-content { margin-top: 0; min-height: 100vh; }

        /* Cards modernos */
        .modern-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-1);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        [data-theme='dark'] .modern-card { box-shadow: var(--shadow-1); }

        .modern-card:hover {
            box-shadow: var(--shadow-2);
            transform: translateY(-2px);
        }

        .modern-card .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .modern-card .card-body {
            padding: 24px;
        }

        /* Botones modernos */
        .btn-modern {
            border-radius: var(--border-radius);
            font-weight: 500;
            padding: 12px 24px;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            box-shadow: var(--shadow-1);
        }

        .btn-modern:hover {
            box-shadow: var(--shadow-2);
            transform: translateY(-1px);
        }

        .btn-primary.btn-modern {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        }

        .btn-success.btn-modern {
            background: linear-gradient(135deg, var(--success-color), #2e7d32);
        }

        .btn-warning.btn-modern {
            background: linear-gradient(135deg, var(--warning-color), #ef6c00);
        }

        .btn-danger.btn-modern {
            background: linear-gradient(135deg, var(--error-color), #c62828);
        }

        /* Métricas del dashboard */
        .metric-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-1);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        [data-theme='dark'] .metric-card { box-shadow: var(--shadow-1); }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }

        .metric-card:hover {
            box-shadow: var(--shadow-2);
            transform: translateY(-2px);
        }

        .metric-card.success::before {
            background: linear-gradient(90deg, var(--success-color), #4caf50);
        }

        .metric-card.warning::before {
            background: linear-gradient(90deg, var(--warning-color), #ff9800);
        }

        .metric-card.danger::before {
            background: linear-gradient(90deg, var(--error-color), #f44336);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .metric-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            background: rgba(50, 153, 55, 0.15);
        }

        [data-theme='dark'] .metric-icon { background: rgba(50,153,55,0.25); }

        .metric-icon .material-icons {
            color: var(--primary-color);
            font-size: 24px;
        }

        /* Forms modernos */
        .form-control {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modern-sidebar { transform: translateX(-100%); top: 0; height: 100vh; }
            .modern-sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            body.header-hidden .main-content { margin-top: 0; }
            .header-content { padding: 0 16px; }
        }

        /* Alertas modernas */
        .alert {
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 20px;
            box-shadow: var(--shadow-1);
        }

        /* Contenedor fijo para mensajes flash (sobre el header) */
        .flash-messages-fixed {
            position: fixed;
            top: 70px; /* altura aproximada del header */
            left: 50%;
            transform: translateX(-50%);
            width: min(640px, 92%);
            z-index: 1100; /* mayor que el header (1000) */
            pointer-events: none; /* permitir clicks pasar excepto en alert */
        }
        .flash-messages-fixed .alert { pointer-events: auto; animation: fadeIn .4s ease; }
        body.header-hidden .flash-messages-fixed { top: 16px; }

        /* Tablas modernas */
        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-1);
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
        }
    [data-theme='dark'] .table thead th { background: #1e1e1e; border-bottom-color: #2c2c2c; }

    /* Usuario & tema */
    .header-actions { display:flex; align-items:center; gap:10px; }
    .user-dropdown { position: relative; display:flex; align-items:center; }
    .user-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color: #fff; border-radius: 40px; padding: 6px 14px; font-weight: 500; transition: all .2s; display:inline-flex; align-items:center; gap:8px; height:40px; }
    .user-btn:hover { background: rgba(255,255,255,0.18); color: #fff; }
    #themeCycleBtn { width:40px; padding:6px; justify-content:center; }
    #themeCycleBtn .material-icons { margin:0; font-size:20px !important; }
    .user-btn img { width:30px; height:30px; border-radius:50%; object-fit:cover; display:block; }
    .user-btn .username-text { font-size:.9rem; line-height:1.1; }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Mobile sidebar / menu button additions --- */
        .mobile-menu-btn {
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            padding: 0;
            cursor: pointer;
        }
        .mobile-menu-btn .material-icons { font-size: 26px; color: #fff; }
        .mobile-menu-btn:focus { outline: 2px solid #fff; outline-offset: 2px; }

        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(2px);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s ease;
        }
        .sidebar-backdrop.show { opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            .mobile-menu-btn { display: inline-flex; }
            .modern-sidebar { width: 260px; box-shadow: var(--shadow-3); }
            body.sidebar-open { overflow: hidden; }
        }
    </style>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/cashcactus_favicon.png') }}">
</head>
<body>
    <!-- Header moderno -->
    <header class="modern-header">
        <div class="header-content">
            {% if current_user.is_authenticated %}
            <button id="mobileMenuBtn" class="mobile-menu-btn me-2" type="button" aria-label="Abrir menú" aria-controls="sidebar" aria-expanded="false">
                <span class="material-icons">menu</span>
            </button>
            {% endif %}
            <a href="{{ url_for('main.dashboard') }}" class="logo" aria-label="Ir al dashboard">
                <img class="logo-img" src="{{ url_for('static', filename='img/cashcactus_topbar.png') }}" alt="Logo CashCactus" />
                <span class="logo-text">CashCactus</span>
            </a>
            {% if current_user.is_authenticated %}
            <div class="header-actions">
                <div class="dropdown user-dropdown">
                    <button class="btn user-btn me-1" id="themeCycleBtn" type="button" title="Cambiar tema (sistema / claro / oscuro)" aria-label="Cambiar tema">
                        <span class="material-icons" id="themeCycleIcon" style="font-size: 18px;">brightness_auto</span>
                    </button>
                    <button class="btn user-btn dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-label="Menú de usuario" style="gap:8px;">
                        {% if current_user.avatar_url %}
                            <img src="{{ current_user.avatar_url }}" alt="Avatar" style="width:28px;height:28px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 1px rgba(255,255,255,0.4);" referrerpolicy="no-referrer" />
                        {% else %}
                            <span class="material-icons" style="font-size: 24px;">account_circle</span>
                        {% endif %}
                        <span class="username-text" style="line-height:1;">{{ current_user.get_full_name() }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="px-3 py-2 text-muted" style="font-size: .75rem; font-weight:600; text-transform:uppercase;">Tema</li>
                        <li class="px-3 pb-2 d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-theme-choice="system">Sistema</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-theme-choice="light">Claro</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-theme-choice="dark">Oscuro</button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('auth.profile') }}">
                                <span class="material-icons" style="font-size: 18px; margin-right: 8px;">settings</span>
                                Perfil
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                <span class="material-icons" style="font-size: 18px; margin-right: 8px;">logout</span>
                                Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </header>

        {# Mensajes flash globales: se muestran siempre justo debajo del header para evitar quedar detrás #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-fixed">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show d-flex align-items-start gap-2" role="alert">
                            {% if category == 'success' %}
                                <span class="material-icons" style="font-size: 20px;">check_circle</span>
                            {% elif category == 'error' or category == 'danger' %}
                                <span class="material-icons" style="font-size: 20px;">error</span>
                            {% elif category == 'warning' %}
                                <span class="material-icons" style="font-size: 20px;">warning</span>
                            {% else %}
                                <span class="material-icons" style="font-size: 20px;">info</span>
                            {% endif %}
                            <div class="flex-grow-1">{{ message }}</div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

    {% if current_user.is_authenticated %}
    <!-- Sidebar moderno -->
    <aside class="modern-sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <div class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}" href="{{ url_for('main.dashboard') }}">
                        <span class="material-icons">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Finanzas</div>
                <div class="nav-item">
                    {% set ep = request.endpoint or '' %}
                    <a class="nav-link {% if ep.startswith('main.account') or ep in ['main.create_account','main.edit_account','main.delete_account'] %}active{% endif %}" href="{{ url_for('main.accounts') }}">
                        <span class="material-icons">account_balance</span>
                        <span>Cuentas</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link {% if 'transaction' in request.endpoint %}active{% endif %}" href="{{ url_for('main.transactions') }}">
                        <span class="material-icons">receipt_long</span>
                        <span>Transacciones</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link {% if 'credit_card' in request.endpoint %}active{% endif %}" href="{{ url_for('main.credit_cards') }}">
                        <span class="material-icons">credit_card</span>
                        <span>Tarjetas</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link {% if request.endpoint and request.endpoint.startswith('main.debt') %}active{% endif %}" href="{{ url_for('main.debt_accounts') }}">
                        <span class="material-icons">account_balance_wallet</span>
                        <span>Deudas</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Reportes</div>
                <div class="nav-item">
                    <a class="nav-link {% if 'monthly_report' in request.endpoint %}active{% endif %}" href="{{ url_for('main.monthly_report') }}">
                        <span class="material-icons">assessment</span>
                        Reporte Mensual
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link {% if 'quarterly_report' in request.endpoint %}active{% endif %}" href="{{ url_for('main.quarterly_report') }}">
                        <span class="material-icons">trending_up</span>
                        Reporte Trimestral
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Herramientas</div>
                <div class="nav-item">
                    <a class="nav-link {% if request.endpoint and 'reminders.' in request.endpoint %}active{% endif %}" href="{{ url_for('reminders.list_reminders') }}">
                        <span class="material-icons">notification_important</span>
                        <span>Recordatorios</span>
                    </a>
                </div>
            </div>
        </div>
    </aside>
    <div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true"></div>
    {% endif %}

    <!-- Contenido principal -->
    <main class="main-content {% if not current_user.is_authenticated %}w-100 m-0{% endif %}">
        <div class="fade-in">
            <!-- Contenido de la página -->
            <div class="pm-container">
                {% block content %}{% endblock %}
            </div>
        </div>
    </main>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Tema: sistema / claro / oscuro con detección automática y preferencia persistente
        (function(){
            const root = document.documentElement;
            const cycleBtn = document.getElementById('themeCycleBtn');
            const cycleIcon = document.getElementById('themeCycleIcon');
            const storageKey = 'themePreference'; // values: system|light|dark
            const mm = window.matchMedia('(prefers-color-scheme: dark)');

            function systemTheme(){ return mm.matches ? 'dark' : 'light'; }
            function currentPref(){ return localStorage.getItem(storageKey) || 'system'; }
            function apply(pref){
                let applied = pref === 'system' ? systemTheme() : pref;
                if(applied === 'dark') root.setAttribute('data-theme','dark'); else root.removeAttribute('data-theme');
                // Icon feedback
                if(cycleIcon){
                    if(pref === 'system') cycleIcon.textContent = 'brightness_auto';
                    else if(applied === 'dark') cycleIcon.textContent = 'dark_mode';
                    else cycleIcon.textContent = 'light_mode';
                }
                // Mark active buttons in dropdown
                document.querySelectorAll('[data-theme-choice]').forEach(btn=>{
                    btn.classList.toggle('btn-primary', btn.getAttribute('data-theme-choice')===pref);
                    btn.classList.toggle('btn-outline-secondary', btn.getAttribute('data-theme-choice')!==pref);
                });
            }
            function cycle(){
                const order = ['system','light','dark'];
                const pref = currentPref();
                const idx = order.indexOf(pref);
                const next = order[(idx+1)%order.length];
                localStorage.setItem(storageKey,next);
                apply(next);
            }
            // Initial
            apply(currentPref());
            // Listen system changes when pref = system
            mm.addEventListener('change', () => { if(currentPref()==='system') apply('system'); });
            cycleBtn && cycleBtn.addEventListener('click', cycle);
            // Dropdown explicit selection
            document.querySelectorAll('[data-theme-choice]').forEach(btn=>{
                btn.addEventListener('click', e=>{ const pref = e.currentTarget.getAttribute('data-theme-choice'); localStorage.setItem(storageKey,pref); apply(pref); });
            });
        })();

        // Auto ocultar header al hacer scroll hacia abajo y mostrar al subir
        (function(){
            const header = document.querySelector('.modern-header');
            if(!header) return;
            let lastY = window.scrollY;
            let ticking = false;
            function onScroll(){
                const current = window.scrollY;
                const delta = current - lastY;
                if(Math.abs(delta) > 8){
                    if(current > 80 && delta > 0){
                        header.classList.add('header-hidden');
                        document.body.classList.add('header-hidden');
                    } else if(delta < 0) {
                        header.classList.remove('header-hidden');
                        document.body.classList.remove('header-hidden');
                    }
                    lastY = current;
                }
                ticking = false;
            }
            window.addEventListener('scroll', () => {
                if(!ticking){ requestAnimationFrame(onScroll); ticking = true; }
            }, { passive: true });
        })();

        // Sidebar compact/expanded toggle
        (function() {
            const root = document.documentElement;
            const btn = document.getElementById('sidebarToggleBtn');
            const pref = localStorage.getItem('sidebar');
            if (pref === 'compact') root.setAttribute('data-sidebar', 'compact');
            if (btn) {
                btn.addEventListener('click', () => {
                    const isCompact = root.getAttribute('data-sidebar') === 'compact';
                    if (isCompact) {
                        root.removeAttribute('data-sidebar');
                        localStorage.setItem('sidebar', 'expanded');
                    } else {
                        root.setAttribute('data-sidebar', 'compact');
                        localStorage.setItem('sidebar', 'compact');
                    }
                });
            }
        })();

        // Auto-cerrar alertas después de 5 segundos
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                const closeBtn = alert.querySelector('.btn-close');
                if (closeBtn) {
                    closeBtn.click();
                }
            });
        }, 5000);

        // Formatear números como moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Aplicar formato de moneda a elementos con clase 'currency'
        document.addEventListener('DOMContentLoaded', function() {
            const currencyElements = document.querySelectorAll('.currency');
            currencyElements.forEach(element => {
                const amount = parseFloat(element.textContent);
                if (!isNaN(amount)) {
                    element.textContent = formatCurrency(amount);
                }
            });

            // Animar entrada de cards
            const cards = document.querySelectorAll('.modern-card, .metric-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('fade-in');
            });
        });

        // Toggle sidebar en móvil + accesibilidad
        (function(){
            const sidebar = document.getElementById('sidebar');
            const btn = document.getElementById('mobileMenuBtn');
            const backdrop = document.getElementById('sidebarBackdrop');
            if(!sidebar || !btn) return;

            const focusableSelectors = 'a[href], button:not([disabled]), [tabindex="0"]';
            let lastFocused;

            function openSidebar(){
                lastFocused = document.activeElement;
                sidebar.classList.add('show');
                backdrop && backdrop.classList.add('show');
                document.body.classList.add('sidebar-open');
                btn.setAttribute('aria-expanded','true');
                // Focus first link
                const firstLink = sidebar.querySelector(focusableSelectors);
                firstLink && firstLink.focus({preventScroll:true});
            }
            function closeSidebar(){
                sidebar.classList.remove('show');
                backdrop && backdrop.classList.remove('show');
                document.body.classList.remove('sidebar-open');
                btn.setAttribute('aria-expanded','false');
                lastFocused && lastFocused.focus({preventScroll:true});
            }
            function toggle(){
                sidebar.classList.contains('show') ? closeSidebar() : openSidebar();
            }
            btn.addEventListener('click', toggle);
            backdrop && backdrop.addEventListener('click', closeSidebar);

            // Cerrar al seleccionar un link en móvil
            sidebar.addEventListener('click', e => {
                if(window.innerWidth <= 768 && e.target.closest('a.nav-link')) closeSidebar();
            });
            // ESC para cerrar
            document.addEventListener('keydown', e => {
                if(e.key === 'Escape' && sidebar.classList.contains('show')) closeSidebar();
            });
            // Ajustar al cambiar tamaño (si pasa a desktop, asegurar estado consistente)
            window.addEventListener('resize', () => {
                if(window.innerWidth > 768){
                    sidebar.classList.remove('show');
                    backdrop && backdrop.classList.remove('show');
                    document.body.classList.remove('sidebar-open');
                    btn.setAttribute('aria-expanded','false');
                }
            });
        })();


        // Smooth scrolling para navegación
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>

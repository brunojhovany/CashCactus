{% extends "base.html" %}

{% block title %}Reporte Mensual - Finanzas Personales{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">📊 Reporte Mensual - {{ month_name }} {{ year }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('main.quarterly_report') }}" class="btn btn-outline-primary">
                📈 Reporte Trimestral
            </a>
            <a href="{{ url_for('main.income_by_account_report') }}" class="btn btn-outline-success">
                💰 Ingresos por Cuenta
            </a>
        </div>
    </div>
</div>

<!-- Resumen Ejecutivo -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6><i class="bi bi-arrow-up-circle"></i> Ingresos Totales</h6>
                <h3>${{ "%.2f"|format(monthly_summary.total_income) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h6><i class="bi bi-arrow-down-circle"></i> Gastos Totales</h6>
                <h3>${{ "%.2f"|format(monthly_summary.total_expenses) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-{% if monthly_summary.net_income >= 0 %}info{% else %}warning{% endif %} text-white">
            <div class="card-body text-center">
                <h6><i class="bi bi-graph-up"></i> Balance Neto</h6>
                <h3>${{ "%.2f"|format(monthly_summary.net_income) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h6><i class="bi bi-wallet2"></i> Patrimonio Neto</h6>
                <h3>${{ "%.2f"|format(net_worth.net_worth) }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Gráficas Principales -->
<div class="row mb-4">
    <!-- Flujo Mensual -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart"></i> Flujo Financiero Mensual</h5>
            </div>
            <div class="card-body">
                {% if monthly_flow_chart %}
                    <img src="data:image/png;base64,{{ monthly_flow_chart }}" class="img-fluid" alt="Flujo Mensual">
                {% else %}
                    <div class="text-center text-muted">
                        <p>Sin datos suficientes para generar el gráfico</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Gastos por Categoría -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Gastos por Categoría</h5>
            </div>
            <div class="card-body">
                {% if expense_chart %}
                    <img src="data:image/png;base64,{{ expense_chart }}" class="img-fluid" alt="Gastos por Categoría">
                {% else %}
                    <div class="text-center text-muted">
                        <p>No hay gastos registrados para este mes</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Análisis de Patrimonio -->
<div class="row mb-4">
    <!-- Activos vs Pasivos -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart-fill"></i> Distribución de Patrimonio</h5>
            </div>
            <div class="card-body">
                {% if assets_liabilities_pie %}
                    <img src="data:image/png;base64,{{ assets_liabilities_pie }}" class="img-fluid" alt="Activos vs Pasivos">
                {% else %}
                    <div class="text-center text-muted">
                        <p>Sin datos de patrimonio disponibles</p>
                    </div>
                {% endif %}
                
                <!-- Resumen numérico -->
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <h6 class="text-success">💰 Activos</h6>
                            <p class="mb-0">${{ "%.2f"|format(net_worth.total_assets) }}</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-danger">💳 Pasivos</h6>
                            <p class="mb-0">${{ "%.2f"|format(net_worth.total_liabilities) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Desglose de Deudas -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="bi bi-exclamation-triangle"></i> Desglose de Deudas</h5>
            </div>
            <div class="card-body">
                {% if debt_breakdown_pie %}
                    <img src="data:image/png;base64,{{ debt_breakdown_pie }}" class="img-fluid" alt="Desglose de Deudas">
                {% else %}
                    <div class="text-center text-success">
                        <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                        <p class="mt-2">¡Sin deudas pendientes!</p>
                    </div>
                {% endif %}
                
                <!-- Resumen de deudas -->
                {% if debt_summary.total_debt > 0 %}
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <h6 class="text-warning">💳 Tarjetas</h6>
                            <p class="mb-0">${{ "%.2f"|format(debt_summary.credit_card_debt) }}</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-danger">📋 Cuentas</h6>
                            <p class="mb-0">${{ "%.2f"|format(debt_summary.account_debt) }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Balances por Cuenta -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bank"></i> Balance por Cuenta</h5>
            </div>
            <div class="card-body">
                {% if account_balances_chart %}
                    <img src="data:image/png;base64,{{ account_balances_chart }}" class="img-fluid" alt="Balance por Cuenta">
                {% else %}
                    <div class="text-center text-muted">
                        <p>No hay cuentas registradas</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Tendencia Anual -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-graph-up-arrow"></i> Tendencia de Ingresos y Gastos {{ year }}</h5>
            </div>
            <div class="card-body">
                {% if income_expense_trend %}
                    <img src="data:image/png;base64,{{ income_expense_trend }}" class="img-fluid" alt="Tendencia Anual">
                {% else %}
                    <div class="text-center text-muted">
                        <p>Sin datos suficientes para mostrar la tendencia anual</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detalles del Mes -->
<div class="row mb-4">
    <!-- Lista de Gastos por Categoría -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list-ul"></i> Detalle de Gastos por Categoría</h5>
            </div>
            <div class="card-body">
                {% if monthly_summary.expenses_by_category %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th class="text-end">Monto</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, amount in monthly_summary.expenses_by_category.items() %}
                                <tr>
                                    <td>{{ category }}</td>
                                    <td class="text-end">${{ "%.2f"|format(amount) }}</td>
                                    <td class="text-end">{{ "%.1f"|format((amount / monthly_summary.total_expenses * 100) if monthly_summary.total_expenses > 0 else 0) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No hay gastos registrados en este mes.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Próximos Pagos -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar-check"></i> Próximos Pagos</h5>
            </div>
            <div class="card-body">
                {% if debt_summary.upcoming_payments %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-end">Monto</th>
                                    <th class="text-end">Vencimiento</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in debt_summary.upcoming_payments[:5] %}
                                <tr class="{% if payment.is_overdue %}table-danger{% elif payment.days_until_due <= 3 %}table-warning{% endif %}">
                                    <td>
                                        <small class="text-muted">
                                            {% if payment.type == 'credit_card' %}💳{% else %}📋{% endif %}
                                        </small>
                                        {{ payment.name }}
                                    </td>
                                    <td class="text-end">${{ "%.2f"|format(payment.amount) }}</td>
                                    <td class="text-end">
                                        <small>
                                            {% if payment.is_overdue %}
                                                <span class="text-danger">Vencido</span>
                                            {% elif payment.days_until_due == 0 %}
                                                <span class="text-warning">Hoy</span>
                                            {% elif payment.days_until_due == 1 %}
                                                <span class="text-warning">Mañana</span>
                                            {% else %}
                                                {{ payment.days_until_due }} días
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-success">🎉 No hay pagos pendientes</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Navegación de Meses -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h6>Navegar por Meses</h6>
                <div class="btn-group" role="group">
                    {% set prev_month = month - 1 if month > 1 else 12 %}
                    {% set prev_year = year if month > 1 else year - 1 %}
                    <a href="{{ url_for('main.monthly_report', year=prev_year, month=prev_month) }}" 
                       class="btn btn-outline-secondary">
                        ← {{ prev_month|month_name }} {{ prev_year }}
                    </a>
                    
                    <a href="{{ url_for('main.monthly_report') }}" class="btn btn-primary">
                        Mes Actual
                    </a>
                    
                    {% set next_month = month + 1 if month < 12 else 1 %}
                    {% set next_year = year if month < 12 else year + 1 %}
                    <a href="{{ url_for('main.monthly_report', year=next_year, month=next_month) }}" 
                       class="btn btn-outline-secondary">
                        {{ next_month|month_name }} {{ next_year }} →
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

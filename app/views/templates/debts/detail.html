{% extends "base.html" %}

{% block title %}{{ debt_account.name }} - Detalles{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-credit-card text-danger me-2"></i>{{ debt_account.name }}</h2>
                    <p class="text-muted mb-0">{{ debt_account.creditor_name }}</p>
                </div>
                <div>
                    <a href="{{ url_for('main.make_debt_payment', debt_id=debt_account.id) }}" class="btn btn-success me-2">
                        <i class="fas fa-money-bill me-1"></i>Hacer Pago
                    </a>
                    <a href="{{ url_for('main.edit_debt_account', debt_id=debt_account.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>Editar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de la deuda -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Deuda Actual</h5>
                    <h3>${{ "%.2f"|format(debt_info.current_debt) }}</h3>
                    <small>
                        {% if debt_info.is_overdue %}
                        <i class="fas fa-exclamation-triangle me-1"></i>Pago Vencido
                        {% else %}
                        Próximo: {{ debt_info.next_payment_due.strftime('%d/%m/%Y') if debt_info.next_payment_due }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Interés Mensual</h5>
                    <h3>${{ "%.2f"|format(debt_info.monthly_interest) }}</h3>
                    <small>{{ debt_account.interest_rate }}% anual</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Pagado</h5>
                    <h3>${{ "%.2f"|format(debt_info.total_paid) }}</h3>
                    <small>de ${{ "%.2f"|format(debt_account.original_debt_amount) }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <h5 class="card-title">Pago Mínimo</h5>
                    <h3>${{ "%.2f"|format(debt_account.minimum_payment) }}</h3>
                    <small>Cada {{ debt_account.payment_due_day }} del mes</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Progreso de pago -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Progreso de Pago</h5>
                </div>
                <div class="card-body">
                    {% set progress_percentage = ((debt_account.original_debt_amount - debt_info.current_debt) / debt_account.original_debt_amount * 100) if debt_account.original_debt_amount > 0 else 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Progreso: {{ "%.1f"|format(progress_percentage) }}%</span>
                        <span>Restante: ${{ "%.2f"|format(debt_info.current_debt) }}</span>
                    </div>
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: {{ progress_percentage }}%">
                            {{ "%.1f"|format(progress_percentage) }}%
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Deuda Original</small>
                            <div class="fw-bold">${{ "%.2f"|format(debt_account.original_debt_amount) }}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Total Pagado</small>
                            <div class="fw-bold text-success">${{ "%.2f"|format(debt_info.total_paid) }}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Deuda Restante</small>
                            <div class="fw-bold text-danger">${{ "%.2f"|format(debt_info.current_debt) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Proyección de pagos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line me-2"></i>Proyección de Pagos (12 meses)</h5>
                </div>
                <div class="card-body">
                    {% if projection %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th>Balance Inicial</th>
                                    <th>Interés</th>
                                    <th>Pago</th>
                                    <th>Balance Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for month_data in projection[:6] %}
                                <tr>
                                    <td>{{ month_data.month }}</td>
                                    <td>${{ "%.2f"|format(month_data.starting_balance) }}</td>
                                    <td class="text-warning">${{ "%.2f"|format(month_data.interest) }}</td>
                                    <td class="text-success">${{ "%.2f"|format(month_data.payment) }}</td>
                                    <td class="{% if month_data.ending_balance < month_data.starting_balance %}text-success{% else %}text-danger{% endif %}">
                                        ${{ "%.2f"|format(month_data.ending_balance) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#full-projection">
                            Ver Proyección Completa (12 meses)
                        </button>
                    </div>
                    
                    <div class="collapse mt-3" id="full-projection">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Mes</th>
                                        <th>Balance Inicial</th>
                                        <th>Interés</th>
                                        <th>Pago</th>
                                        <th>Balance Final</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for month_data in projection %}
                                    <tr>
                                        <td>{{ month_data.month }}</td>
                                        <td>${{ "%.2f"|format(month_data.starting_balance) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(month_data.interest) }}</td>
                                        <td class="text-success">${{ "%.2f"|format(month_data.payment) }}</td>
                                        <td class="{% if month_data.ending_balance < month_data.starting_balance %}text-success{% else %}text-danger{% endif %}">
                                            ${{ "%.2f"|format(month_data.ending_balance) }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No se puede calcular proyección sin tasa de interés o pago mínimo.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de transacciones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-history me-2"></i>Historial de Transacciones</h5>
                    <a href="{{ url_for('main.account_transactions', account_id=debt_account.id) }}" class="btn btn-sm btn-outline-primary">
                        Ver Todas
                    </a>
                </div>
                <div class="card-body">
                    {% if transactions %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripción</th>
                                    <th>Tipo</th>
                                    <th>Monto</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        {{ transaction.description }}
                                        {% if transaction.is_automatic %}
                                        <span class="badge bg-secondary ms-1">Auto</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if transaction.transaction_type == 'income' %}
                                        <span class="badge bg-success">Pago</span>
                                        {% else %}
                                        <span class="badge bg-danger">{{ transaction.get_category_display() }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="{% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}${{ "%.2f"|format(transaction.amount) }}
                                    </td>
                                    <td>
                                        <!-- Aquí se podría calcular el balance en esa fecha -->
                                        <small class="text-muted">-</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No hay transacciones registradas para esta deuda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tooltip para elementos con información adicional
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
